<header class="topbar">
  <%
    const noteList = typeof notifications !== "undefined" && Array.isArray(notifications) ? notifications : [];
    const pathValue = typeof activePath === "string" ? activePath : "";
    const q = typeof query === "string" ? query : "";
    const user = typeof currentUser !== "undefined" ? currentUser : null;
    const canMod = Boolean(typeof canModerate !== "undefined" && canModerate);
    const canAdminFlag = Boolean(typeof canAdmin !== "undefined" && canAdmin);
  %>
  <div class="topbar-inner">
    <a class="wordmark" href="/">VIKS</a>
    <% if (pathValue && pathValue !== "/") { %>
    <a class="back-btn" href="/" aria-label="Back">&#x2039;</a>
    <% } %>

    <div class="topbar-spacer"></div>

    <a class="icon-btn" href="/search?q=<%= encodeURIComponent(q) %>" aria-label="Search">
      <span>&#x1F50D;</span>
    </a>

    <% if (user) { %>
    <details class="notify-wrap">
      <summary class="icon-btn <%= noteList.length ? 'has-alert' : '' %>" aria-label="Notifications">
        <span>&#x1F514;</span>
      </summary>
      <section class="notify-dropdown">
        <header>
          <strong>Notifications</strong>
          <a href="/notifications">View all</a>
        </header>
        <div class="notify-list">
          <% if (noteList.length === 0) { %>
          <p class="notify-empty">No activity yet.</p>
          <% } %>
          <% for (const item of noteList.slice(0, 10)) { %>
          <a class="notify-item" href="/posts/<%= item.post_id %>">
            <img
              src="<%= item.actor_avatar_url || 'https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=80&q=80' %>"
              alt="<%= item.actor_username %>"
            />
            <span>
              <strong><%= item.actor_username %></strong> <%= item.message %>
              <small><%= item.context %></small>
            </span>
          </a>
          <% } %>
        </div>
      </section>
    </details>

    <a class="pill-btn pill-ghost" href="<%= user.email_verified ? '/posts/new' : '/account' %>">
      <span class="pill-icon">&#x270E;</span>
      <span>Write</span>
    </a>

    <details class="user-menu-wrap">
      <summary class="user-chip" aria-label="Account menu">
        <img
          src="<%= user.avatar_url || 'https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=80&q=80' %>"
          alt="<%= user.username %>"
        />
        <span class="caret">&#x2304;</span>
      </summary>
      <div class="user-dropdown">
        <div class="user-dropdown-head">My profile</div>

        <a class="user-profile-card" href="/account">
          <img
            src="<%= user.avatar_url || 'https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=80&q=80' %>"
            alt="<%= user.username %>"
          />
          <span>
            <strong><%= user.username %></strong>
            <small>@id<%= user.id %></small>
          </span>
        </a>

        <nav class="user-menu-list" aria-label="Profile menu">
          <a class="menu-row" href="/account?tab=posts">
            <span class="menu-icon">&#x270E;</span>
            <span class="menu-label">Drafts</span>
          </a>

          <a class="menu-row" href="/bookmarks">
            <span class="menu-icon">&#x1F516;</span>
            <span class="menu-label">Bookmarks</span>
          </a>

          <a class="menu-row" href="/account">
            <span class="menu-icon">&#x1F3C6;</span>
            <span class="menu-label">Achievements</span>
          </a>

          <a class="menu-row menu-row-split" href="/account">
            <span class="menu-main">
              <span class="menu-icon">&#x20BD;</span>
              <span class="menu-label">Donations</span>
            </span>
            <span class="menu-chip">Connect</span>
          </a>

          <a class="menu-row menu-row-split" href="/account?tab=settings">
            <span class="menu-main">
              <span class="menu-icon">&#x2699;</span>
              <span class="menu-label">Settings</span>
            </span>
            <span class="menu-toggle-dot" aria-hidden="true"></span>
          </a>

          <a class="menu-row" href="/account">
            <span class="menu-icon">&#x1F48E;</span>
            <span class="menu-label">Plus subscription</span>
          </a>

          <% if (canMod) { %>
          <a class="menu-row" href="/moderation/queue">
            <span class="menu-icon">&#x1F6E1;</span>
            <span class="menu-label">Moderation</span>
          </a>
          <% } %>

          <% if (canAdminFlag) { %>
          <a class="menu-row" href="/admin/users">
            <span class="menu-icon">&#x1F4BC;</span>
            <span class="menu-label">Admin</span>
          </a>
          <% } %>
        </nav>

        <form class="menu-logout-form" method="post" action="/logout">
          <button class="menu-row menu-logout-btn" type="submit">
            <span class="menu-icon">&#x21AA;</span>
            <span class="menu-label">Log out</span>
          </button>
        </form>
      </div>
    </details>
    <% } else { %>
    <a class="pill-btn pill-ghost" href="/login">
      <span class="pill-icon">&#x270E;</span>
      <span>Write</span>
    </a>
    <a class="pill-btn pill-primary" href="/login">Log in</a>
    <% } %>
  </div>
</header>
