<%- include("partials/head", { pageTitle }) %>

<section class="account-layout">
  <section class="panel profile-card">
    <div class="profile-header">
      <img
        src="<%= profileUser.avatar_url || 'https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=160&q=80' %>"
        alt="<%= profileUser.username %>"
      />
      <div>
        <h1>@<%= profileUser.username %></h1>
        <p>Joined <%= new Date(profileUser.created_at).toLocaleDateString() %></p>
      </div>
    </div>
    <p class="profile-bio"><%= profileUser.bio || 'No bio yet.' %></p>
    <div class="profile-stats">
      <div>
        <strong><%= posts.length %></strong>
        <span>Publications</span>
      </div>
      <div>
        <strong><%= bookmarks.total %></strong>
        <span>Bookmarks</span>
      </div>
      <div>
        <strong><%= profileUser.role %></strong>
        <span>Role</span>
      </div>
      <div>
        <strong><%= profileUser.email_verified ? 'Yes' : 'No' %></strong>
        <span>Email verified</span>
      </div>
    </div>
  </section>

  <section class="panel form-card">
    <h2>Edit account</h2>
    <form method="post" action="/account" class="stack-form">
      <label>
        Avatar URL
        <input type="url" name="avatar_url" value="<%= profileUser.avatar_url %>" placeholder="https://..." />
      </label>
      <label>
        Bio
        <textarea name="bio" maxlength="280" placeholder="Tell people what you create"><%= profileUser.bio %></textarea>
      </label>
      <button class="btn" type="submit">Save profile</button>
    </form>
  </section>
</section>

<section class="panel">
  <div class="tab-row">
    <a class="<%= tab === 'posts' ? 'is-active' : '' %>" href="/account?tab=posts">Posts</a>
    <a class="<%= tab === 'bookmarks' ? 'is-active' : '' %>" href="/account?tab=bookmarks">Bookmarks</a>
    <% if (canModerate) { %>
    <a class="<%= tab === 'moderation' ? 'is-active' : '' %>" href="/account?tab=moderation">Moderation</a>
    <% } %>
  </div>

  <% if (tab === 'bookmarks') { %>
  <h2>My bookmarks</h2>
  <% if (bookmarks.items.length === 0) { %>
  <p class="fine-print">No bookmarks yet.</p>
  <% } %>
  <div class="compact-list">
    <% for (const post of bookmarks.items) { %>
    <a href="/posts/<%= post.id %>">
      <strong><%= post.title %></strong>
      <span>
        <%= post.category_name %> • <%= post.reading_time_minutes %> min •
        <%= post.like_count %> likes • <%= post.comment_count %> comments
      </span>
    </a>
    <% } %>
  </div>
  <% if (bookmarks.pages > 1) { %>
  <nav class="pagination">
    <% if (bookmarks.page > 1) { %>
    <a href="/account?tab=bookmarks&bookmark_page=<%= bookmarks.page - 1 %>">Previous</a>
    <% } %>
    <span>Page <%= bookmarks.page %> of <%= bookmarks.pages %></span>
    <% if (bookmarks.page < bookmarks.pages) { %>
    <a href="/account?tab=bookmarks&bookmark_page=<%= bookmarks.page + 1 %>">Next</a>
    <% } %>
  </nav>
  <% } %>
  <% } else if (tab === 'moderation' && canModerate) { %>
  <h2>Moderation queue</h2>
  <p class="fine-print">Open dedicated queue: <a href="/moderation/queue">/moderation/queue</a></p>
  <div class="compact-list">
    <% for (const report of moderation.items) { %>
    <div>
      <strong>#<%= report.id %> • <%= report.target_type %> <%= report.target_id %> • <%= report.status %></strong>
      <span>Reporter: @<%= report.reporter_username %> • Assigned: <%= report.assignee_username || 'nobody' %></span>
    </div>
    <% } %>
  </div>
  <% if (moderation.pages > 1) { %>
  <nav class="pagination">
    <% if (moderation.page > 1) { %>
    <a href="/account?tab=moderation&status=<%= moderationStatus %>&mod_page=<%= moderation.page - 1 %>">Previous</a>
    <% } %>
    <span>Page <%= moderation.page %> of <%= moderation.pages %></span>
    <% if (moderation.page < moderation.pages) { %>
    <a href="/account?tab=moderation&status=<%= moderationStatus %>&mod_page=<%= moderation.page + 1 %>">Next</a>
    <% } %>
  </nav>
  <% } %>
  <% } else { %>
  <h2>My publications</h2>
  <% if (posts.length === 0) { %>
  <p class="fine-print">No publications yet.</p>
  <% } %>
  <div class="compact-list">
    <% for (const post of posts) { %>
    <a href="/posts/<%= post.id %>">
      <strong><%= post.title %></strong>
      <span>
        <%= post.category_name %> • <%= post.reading_time_minutes %> min •
        <%= post.like_count %> likes • <%= post.comment_count %> comments
      </span>
    </a>
    <% } %>
  </div>
  <% } %>
</section>

<%- include("partials/footer") %>
