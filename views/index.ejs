<%- include("partials/head", { pageTitle, query }) %>

<section class="app-shell">
  <aside class="rail-left">
    <div class="rail-block">
      <a class="nav-pill <%= activePath === '/' && !filters.category && !filters.tag && !filters.q ? 'is-active' : '' %>" href="/">
        <span class="nav-icon">üî•</span>
        <span>Popular</span>
      </a>
      <a class="nav-pill <%= filters.q ? 'is-active' : '' %>" href="/search?q=<%= encodeURIComponent(filters.q || '') %>">
        <span class="nav-icon">‚è∫</span>
        <span>Fresh</span>
      </a>
      <a class="nav-pill <%= activePath === '/bookmarks' ? 'is-active' : '' %>" href="<%= currentUser ? '/bookmarks' : '/login' %>">
        <span class="nav-icon">‚ñ£</span>
        <span>My feed</span>
      </a>
      <a class="nav-pill <%= activePath === '/account' ? 'is-active' : '' %>" href="<%= currentUser ? '/account' : '/login' %>">
        <span class="nav-icon">‚óî</span>
        <span>Profile</span>
      </a>
      <a class="nav-pill <%= activePath === '/moderation/queue' ? 'is-active' : '' %>" href="<%= canModerate ? '/moderation/queue' : '/' %>">
        <span class="nav-icon">‚óÜ</span>
        <span>Rating</span>
      </a>
      <a class="nav-pill" href="/">
        <span class="nav-icon">‚óé</span>
        <span>Quiz</span>
      </a>
    </div>

    <div class="rail-section">
      <h4>Topics</h4>
      <div class="topic-list">
        <% for (const category of categories) { %>
        <a
          class="topic-row <%= filters.category === category.slug ? 'is-active' : '' %>"
          href="/?<%= new URLSearchParams({ category: category.slug, tag: filters.tag || '', q: filters.q || '' }).toString() %>"
        >
          <span class="topic-avatar"><%= category.name.charAt(0).toUpperCase() %></span>
          <span><%= category.name %></span>
        </a>
        <% } %>
      </div>
    </div>

    <div class="rail-section">
      <h4>Tags</h4>
      <div class="tag-cloud">
        <% for (const tag of popularTags.slice(0, 10)) { %>
        <a
          class="tag-chip <%= selectedTag && selectedTag.slug === tag.slug ? 'is-active' : '' %>"
          href="/?<%= new URLSearchParams({ category: filters.category || '', tag: tag.slug, q: filters.q || '' }).toString() %>"
        >
          #<%= tag.slug %>
        </a>
        <% } %>
      </div>
    </div>
  </aside>

  <section class="feed-main">
    <div class="feed-date-row">
      <span><%= new Date().toLocaleDateString("en-US", { day: "numeric", month: "long" }) %></span>
      <span class="chevron">‚ñæ</span>
    </div>

    <section class="top-news-card">
      <h3>Top news</h3>
      <div class="top-news-list">
        <% for (const item of trending) { %>
        <a class="top-news-item" href="/posts/<%= item.id %>">
          <span class="headline"><%= item.title %></span>
          <span class="count">üí¨ <%= item.like_count %></span>
        </a>
        <% } %>
      </div>
      <a class="top-news-more" href="/">Show more</a>
    </section>

    <div class="post-stream">
      <% if (posts.length === 0) { %>
      <article class="post-card">
        <h3>No publications yet</h3>
        <p>Try another filter or publish the first post.</p>
      </article>
      <% } %>

      <% for (const post of posts) { %>
      <article class="post-card <%= post.is_hidden ? 'post-hidden' : '' %>">
        <header class="author-row">
          <a class="author-meta" href="/u/<%= post.author_username %>">
            <img
              src="<%= post.author_avatar_url || 'https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=80&q=80' %>"
              alt="<%= post.author_username %>"
            />
            <div>
              <strong><%= post.author_username %></strong>
              <span>
                <a href="/categories/<%= post.category_slug %>"><%= post.category_name %></a> ‚Ä¢ <%= post.created_relative %>
              </span>
            </div>
          </a>
          <button class="follow-btn" type="button">Follow</button>
        </header>

        <a class="post-title" href="/posts/<%= post.id %>"><%= post.title %></a>
        <p class="post-excerpt"><%= post.excerpt %></p>
        <div class="meta-row">
          <span><%= post.reading_time_minutes %> min read</span>
          <% if (post.tags.length) { %>
          <span>
            <% for (const tag of post.tags) { %>
            <a href="/tags/<%= tag.slug %>">#<%= tag.slug %></a>
            <% } %>
          </span>
          <% } %>
        </div>

        <% if (post.media_type === "image" && post.media_url) { %>
        <img class="post-media" src="<%= post.media_url %>" alt="<%= post.title %>" />
        <% } %>
        <% if (post.media_type === "video" && post.media_url) { %>
        <% if (post.youtube_embed_url) { %>
        <div class="video-wrap">
          <iframe
            src="<%= post.youtube_embed_url %>"
            title="<%= post.title %>"
            loading="lazy"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          ></iframe>
        </div>
        <% } else { %>
        <video class="post-media" controls src="<%= post.media_url %>"></video>
        <% } %>
        <% } %>

        <footer class="post-actions">
          <% if (currentUser && currentUser.email_verified) { %>
          <form method="post" action="/posts/<%= post.id %>/like">
            <button class="btn btn-small <%= post.liked_by_me ? 'btn-like-active' : 'btn-muted' %>" type="submit">
              Like <%= post.like_count %>
            </button>
          </form>
          <form method="post" action="/posts/<%= post.id %>/bookmark">
            <button class="btn btn-small <%= post.bookmarked_by_me ? 'btn-bookmark-active' : 'btn-muted' %>" type="submit">
              Save <%= post.bookmark_count %>
            </button>
          </form>
          <% } else { %>
          <a class="btn btn-small btn-muted" href="/login">Like <%= post.like_count %></a>
          <% } %>
          <a class="btn btn-small btn-muted" href="/posts/<%= post.id %>#comments">Comments <%= post.comment_count %></a>
          <a class="btn btn-small btn-muted" href="/posts/<%= post.id %>">Open</a>
        </footer>
      </article>
      <% } %>
    </div>

    <% if (pagination.pages > 1) { %>
    <nav class="pagination">
      <% if (pagination.page > 1) { %>
      <a href="/?<%= new URLSearchParams({ category: filters.category || '', tag: filters.tag || '', q: filters.q || '', page: pagination.page - 1 }).toString() %>">
        Previous
      </a>
      <% } %>
      <span>Page <%= pagination.page %> of <%= pagination.pages %></span>
      <% if (pagination.page < pagination.pages) { %>
      <a href="/?<%= new URLSearchParams({ category: filters.category || '', tag: filters.tag || '', q: filters.q || '', page: pagination.page + 1 }).toString() %>">
        Next
      </a>
      <% } %>
    </nav>
    <% } %>
  </section>

  <aside class="rail-right">
    <section class="top-blogs-card">
      <h3>Top blogs</h3>
      <ol class="rank-list">
        <% creators.slice(0, 5).forEach((creator, idx) => { %>
        <li>
          <span class="rank-num"><%= idx + 1 %></span>
          <a href="/u/<%= creator.username %>" class="rank-user">
            <img
              src="<%= creator.avatar_url || 'https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=80&q=80' %>"
              alt="<%= creator.username %>"
            />
            <span>
              <strong><%= creator.username %></strong>
              <small><%= creator.received_likes %> likes</small>
            </span>
          </a>
        </li>
        <% }) %>
      </ol>
      <a class="rank-more" href="/">View full top</a>
    </section>
  </aside>
</section>

<%- include("partials/footer") %>
