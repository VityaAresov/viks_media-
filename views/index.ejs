<%- include("partials/head", { pageTitle, query: typeof query === "string" ? query : "" }) %>
<%
  const f = filters || { category: "", tag: "", q: "" };
  const dateLabel = new Date().toLocaleDateString("en-US", { day: "numeric", month: "long" });
  const trendingItems = typeof trending !== "undefined" && Array.isArray(trending) ? trending : [];
  const postsList = typeof posts !== "undefined" && Array.isArray(posts) ? posts : [];
  const pager =
    typeof pagination !== "undefined" && pagination
      ? pagination
      : { page: 1, pages: 1, total: postsList.length };
%>

<section class="app-shell">
  <%- include("partials/left-rail", { filters: f, selectedTag: typeof selectedTag !== "undefined" ? selectedTag : null }) %>

  <section class="feed-main">
    <div class="feed-date-row">
      <span><%= dateLabel %></span>
      <span class="chevron">&#x2304;</span>
    </div>

    <section class="top-news-card">
      <h3>Top news</h3>
      <div class="top-news-list">
        <% for (const item of trendingItems.slice(0, 6)) { %>
        <a class="top-news-item" href="/posts/<%= item.id %>">
          <span class="headline"><%= item.title %></span>
          <span class="count"><%= item.like_count %></span>
        </a>
        <% } %>
      </div>
      <a class="top-news-more" href="/">Show more</a>
    </section>

    <div class="post-stream">
      <% if (postsList.length === 0) { %>
      <article class="post-card">
        <h3>No publications yet</h3>
        <p class="fine-print">Try another filter or publish the first post.</p>
      </article>
      <% } %>

      <% for (const post of postsList) { %>
      <article class="post-card <%= post.is_hidden ? 'post-hidden' : '' %>">
        <header class="author-row">
          <a class="author-meta" href="/u/<%= post.author_username %>">
            <img
              src="<%= post.author_avatar_url || 'https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=80&q=80' %>"
              alt="<%= post.author_username %>"
            />
            <div>
              <strong><%= post.author_username %></strong>
              <span><a href="/categories/<%= post.category_slug %>"><%= post.category_name %></a> <%= post.created_relative %></span>
            </div>
          </a>
          <button class="follow-btn" type="button">Subscribe</button>
        </header>

        <a class="post-title" href="/posts/<%= post.id %>"><%= post.title %></a>
        <p class="post-excerpt"><%= post.excerpt %></p>

        <% if (post.media_type === "image" && post.media_url) { %>
        <img class="post-media" src="<%= post.media_url %>" alt="<%= post.title %>" />
        <% } %>
        <% if (post.media_type === "video" && post.media_url) { %>
        <% if (post.youtube_embed_url) { %>
        <div class="video-wrap">
          <iframe
            src="<%= post.youtube_embed_url %>"
            title="<%= post.title %>"
            loading="lazy"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          ></iframe>
        </div>
        <% } else { %>
        <video class="post-media" controls src="<%= post.media_url %>"></video>
        <% } %>
        <% } %>

        <div class="meta-row">
          <span><%= post.reading_time_minutes %> min read</span>
          <% if (post.tags.length) { %>
          <span>
            <% for (const tag of post.tags) { %>
            <a href="/tags/<%= tag.slug %>">#<%= tag.slug %></a>
            <% } %>
          </span>
          <% } %>
        </div>

        <footer class="post-actions compact-row">
          <% if (currentUser && currentUser.email_verified) { %>
          <form method="post" action="/posts/<%= post.id %>/like">
            <button class="btn btn-small <%= post.liked_by_me ? 'btn-like-active' : 'btn-muted' %>" type="submit">
              &#x2661; <%= post.like_count %>
            </button>
          </form>
          <form method="post" action="/posts/<%= post.id %>/bookmark">
            <button class="btn btn-small <%= post.bookmarked_by_me ? 'btn-bookmark-active' : 'btn-muted' %>" type="submit">
              &#x1F516; <%= post.bookmark_count %>
            </button>
          </form>
          <% } else { %>
          <a class="btn btn-small btn-muted" href="/login">&#x2661; <%= post.like_count %></a>
          <% } %>
          <a class="btn btn-small btn-muted" href="/posts/<%= post.id %>#comments">&#x1F5E8; <%= post.comment_count %></a>
          <a class="btn btn-small btn-muted" href="/posts/<%= post.id %>">Open</a>
        </footer>
      </article>
      <% } %>
    </div>

    <% if (pager.pages > 1) { %>
    <nav class="pagination">
      <% if (pager.page > 1) { %>
      <a href="/?<%= new URLSearchParams({ category: f.category || '', tag: f.tag || '', q: f.q || '', page: pager.page - 1 }).toString() %>">
        Previous
      </a>
      <% } %>
      <span>Page <%= pager.page %> of <%= pager.pages %></span>
      <% if (pager.page < pager.pages) { %>
      <a href="/?<%= new URLSearchParams({ category: f.category || '', tag: f.tag || '', q: f.q || '', page: pager.page + 1 }).toString() %>">
        Next
      </a>
      <% } %>
    </nav>
    <% } %>
  </section>

  <%- include("partials/right-rail") %>
</section>

<%- include("partials/footer") %>
