<%- include("partials/head", { pageTitle }) %>

<section class="app-shell">
  <%- include("partials/left-rail", { filters: null, selectedTag: null }) %>

  <section class="feed-main">
    <article class="editor-stage panel">
      <form method="post" action="/posts" class="editor-form" id="new-post-form">
        <header class="editor-head">
          <div class="editor-author">
            <img
              src="<%= currentUser.avatar_url || 'https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=80&q=80' %>"
              alt="<%= currentUser.username %>"
            />
            <div>
              <strong><%= currentUser.username %></strong>
              <small>Draft mode</small>
            </div>
          </div>
          <div class="editor-head-fields">
            <label>
              Topic
              <select name="category_id" required>
                <% for (const category of categories) { %>
                <option value="<%= category.id %>"><%= category.name %></option>
                <% } %>
              </select>
            </label>
          </div>
        </header>

        <input
          class="editor-title"
          type="text"
          name="title"
          required
          minlength="6"
          maxlength="160"
          placeholder="Publication title"
        />

        <textarea
          class="editor-body"
          name="markdown_body"
          id="markdown_body"
          required
          minlength="20"
          maxlength="20000"
          placeholder="Write your publication in markdown..."
        ></textarea>

        <div class="editor-side-fields">
          <label>
            Tags
            <input type="text" name="tags" maxlength="120" placeholder="video, camera, workflow" />
          </label>

          <label>
            Media type
            <select name="media_type">
              <option value="none">No media</option>
              <option value="image">Image</option>
              <option value="video">Video</option>
            </select>
          </label>

          <label>
            Media URL
            <input type="url" name="media_url" placeholder="https://..." />
          </label>
        </div>

        <footer class="editor-footer">
          <button class="btn btn-primary-large" type="submit">Publish</button>
          <button class="btn btn-muted" type="button" id="preview-btn">Preview</button>
          <span class="editor-save-state">Saved</span>
        </footer>
      </form>
    </article>

    <section class="panel markdown-preview-card editor-preview-card">
      <h2>Preview</h2>
      <div id="markdown-preview" class="markdown-rendered">
        <p class="fine-print">Click Preview to render markdown.</p>
      </div>
    </section>
  </section>

  <%- include("partials/right-rail") %>
</section>

<script>
  (() => {
    const previewButton = document.getElementById("preview-btn");
    const markdownInput = document.getElementById("markdown_body");
    const preview = document.getElementById("markdown-preview");
    if (!previewButton || !markdownInput || !preview) return;

    previewButton.addEventListener("click", async () => {
      previewButton.disabled = true;
      previewButton.textContent = "Rendering...";
      try {
        const response = await fetch("/preview-markdown", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ markdown: markdownInput.value })
        });
        const data = await response.json();
        if (!response.ok) {
          preview.innerHTML = "<p class='fine-print'>Preview failed.</p>";
        } else {
          preview.innerHTML = data.html || "<p class='fine-print'>No content.</p>";
        }
      } catch (error) {
        preview.innerHTML = "<p class='fine-print'>Preview failed.</p>";
      } finally {
        previewButton.disabled = false;
        previewButton.textContent = "Preview";
      }
    });
  })();
</script>

<%- include("partials/footer") %>