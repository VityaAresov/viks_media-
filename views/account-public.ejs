<%- include("partials/head", { pageTitle }) %>
<%
  const totalLikes = posts.reduce((sum, post) => sum + post.like_count, 0);
  const joinedYear = new Date(profileUser.created_at).getFullYear();
%>

<section class="app-shell">
  <%- include("partials/left-rail", { filters: null, selectedTag: null }) %>

  <section class="feed-main profile-main">
    <article class="panel profile-hero-card">
      <div class="profile-cover"></div>
      <div class="profile-hero-body">
        <img
          class="profile-avatar"
          src="<%= profileUser.avatar_url || 'https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=220&q=80' %>"
          alt="<%= profileUser.username %>"
        />

        <div class="profile-hero-meta">
          <h1><%= profileUser.username %></h1>
          <p class="handle">@<%= profileUser.username %></p>
          <p class="fine-print">Joined in <%= joinedYear %></p>
          <p class="profile-bio"><%= profileUser.bio || 'Media creator profile.' %></p>

          <div class="profile-inline-stats">
            <span><strong><%= posts.length %></strong> posts</span>
            <span><strong><%= totalLikes %></strong> reactions</span>
            <span><strong><%= profileUser.role %></strong> role</span>
          </div>
        </div>

        <div class="profile-hero-actions">
          <% if (isOwner) { %>
          <a class="btn" href="/account">Edit profile</a>
          <a class="btn btn-muted" href="/account?tab=settings">Settings</a>
          <% } else { %>
          <button class="btn" type="button">Subscribe</button>
          <button class="btn btn-muted" type="button">Message</button>
          <form method="post" action="/reports" class="inline-form">
            <input type="hidden" name="target_type" value="user" />
            <input type="hidden" name="target_id" value="<%= profileUser.id %>" />
            <input type="hidden" name="reason_code" value="abuse" />
            <input type="hidden" name="reason_text" value="Reported user profile <%= profileUser.username %>" />
            <button class="btn btn-muted" type="submit">Report</button>
          </form>
          <% } %>
        </div>
      </div>

      <div class="tab-row profile-tabs">
        <a class="is-active" href="/u/<%= profileUser.username %>">Posts</a>
        <a href="/u/<%= profileUser.username %>">Comments</a>
      </div>
    </article>

    <div class="feed-sort-row">Fresh &#x2304;</div>

    <div class="post-stream">
      <% if (posts.length === 0) { %>
      <article class="post-card">
        <h3>No publications yet</h3>
        <p class="fine-print">This profile has not published anything.</p>
      </article>
      <% } %>

      <% for (const post of posts) { %>
      <article class="post-card">
        <header class="author-row">
          <a class="author-meta" href="/u/<%= profileUser.username %>">
            <img
              src="<%= profileUser.avatar_url || 'https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=80&q=80' %>"
              alt="<%= profileUser.username %>"
            />
            <div>
              <strong><%= profileUser.username %></strong>
              <span><a href="/categories/<%= post.category_slug %>"><%= post.category_name %></a> <%= post.created_relative %></span>
            </div>
          </a>
          <span class="dot-menu">...</span>
        </header>

        <a class="post-title" href="/posts/<%= post.id %>"><%= post.title %></a>
        <p class="post-excerpt"><%= post.excerpt %></p>

        <% if (post.media_type === "image" && post.media_url) { %>
        <img class="post-media" src="<%= post.media_url %>" alt="<%= post.title %>" />
        <% } %>

        <footer class="post-actions compact-row">
          <a class="btn btn-small btn-muted" href="/posts/<%= post.id %>">&#x2661; <%= post.like_count %></a>
          <a class="btn btn-small btn-muted" href="/posts/<%= post.id %>#comments">&#x1F5E8; <%= post.comment_count %></a>
          <a class="btn btn-small btn-muted" href="/posts/<%= post.id %>">Open</a>
        </footer>
      </article>
      <% } %>
    </div>
  </section>

  <%- include("partials/right-rail") %>
</section>

<%- include("partials/footer") %>